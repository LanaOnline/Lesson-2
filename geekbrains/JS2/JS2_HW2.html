<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>JS2 HW2 Svetlana Morgun</title>
</head>
<body>
	<input class="user_login" type="text"/>
	<script>

	function CheckLoginAvailability(selector) {
		var _this = this;
		var xhr = new XMLHttpRequest(),
			checkTimer;
		
		this.textInput = document.querySelector(selector);
		this.msg = document.createElement('span');
		this.textInput.parentNode.appendChild(_this.msg);

		function updateMsg(avail) {
			switch (avail) {
				case 1: 
					_this.msg.innerText = 'Enter at least 6 characters';
					_this.msg.style.color = 'black';
					break;
				case 2: 
					_this.msg.innerText = 'Available login!';
					_this.msg.style.color = 'green';
					break;
				case 3:
					_this.msg.innerText = 'This login is reserved. Try another one.';
					_this.msg.style.color = 'red';
					break;
			}
		}

		function deleteMsg() {
				_this.msg.innerText = '';
		}

		this.textInput.onkeyup = function() {
			var login = this.value,
				users = [];
				
			if (checkTimer) {
				clearTimeout(checkTimer);
			}

			checkTimer = setTimeout(function() {
				xhr.open('GET', 'data/users.json', true);
				xhr.setRequestHeader('Content-Type', 'application/json');
				xhr.send();
				
				xhr.onreadystatechange = function() {
		            if (xhr.readyState != 4) return;

					if (login.length == 0) {
						deleteMsg();
					} else if (login.length >= 1 && login.length < 6) {
						updateMsg(1);
					} else if (login.length >= 6) {
						if (xhr.status != 200) {
							alert( xhr.status + ': ' + xhr.statusText );
						} else {
							users = JSON.parse(xhr.responseText);

							if (users.find(function(item) {
								return item.userlogin === login;
							})) {
								updateMsg(3);
							} else {
								updateMsg(2);
							}
						}
					}
				}
			}, 1000);
		}
	}

	var msg = new CheckLoginAvailability('.user_login');
	
	</script>
</body>
</html>